{% extends "base.html" %}

{% block title %}FontGen - Generate Custom Fonts{% endblock %}

{% block content %}
<!-- Header -->
<div class="row">
    <div class="col-12 text-center mb-4">
        <h1 class="display-4 mb-3">
            <i class="bi bi-vector-pen me-3"></i>FontGen
        </h1>
        <p class="lead text-muted">
            Turn your handwriting into professional TTF fonts using advanced vectorization
        </p>
    </div>
</div>

<!-- Main Layout with Sidebar -->
<div class="row g-4">
    <!-- Settings Sidebar -->
    <div class="col-xl-3 col-lg-4">
        <div class="settings-sidebar">
            <!-- Font Settings Card -->
            <div class="card card-custom mb-4" id="settings-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders me-2"></i>Font Settings
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Font Name -->
                    <div class="mb-3">
                        <label for="font-name" class="form-label">Font Name</label>
                        <input type="text" class="form-control" id="font-name" placeholder="Enter font name" value="MyFont">
                    </div>
                    
                    <!-- Character Scaling -->
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Uppercase Scale</span>
                            <span class="slider-value" id="uppercase-scale-value">4.0x</span>
                        </div>
                        <input type="range" class="form-range" id="uppercase-scale" min="1" max="8" step="0.1" value="4.0" 
                               oninput="updateSliderValue('uppercase-scale-value', this.value + 'x'); updatePreviewLive()">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Lowercase Scale</span>
                            <span class="slider-value" id="lowercase-scale-value">2.8x</span>
                        </div>
                        <input type="range" class="form-range" id="lowercase-scale" min="1" max="8" step="0.1" value="2.8" 
                               oninput="updateSliderValue('lowercase-scale-value', this.value + 'x'); updatePreviewLive()">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Numbers Scale</span>
                            <span class="slider-value" id="numbers-scale-value">3.8x</span>
                        </div>
                        <input type="range" class="form-range" id="numbers-scale" min="1" max="8" step="0.1" value="3.8" 
                               oninput="updateSliderValue('numbers-scale-value', this.value + 'x'); updatePreviewLive()">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Symbols Scale</span>
                            <span class="slider-value" id="symbols-scale-value">3.5x</span>
                        </div>
                        <input type="range" class="form-range" id="symbols-scale" min="1" max="8" step="0.1" value="3.5" 
                               oninput="updateSliderValue('symbols-scale-value', this.value + 'x'); updatePreviewLive()">
                    </div>

                    <!-- Font Spacing -->
                    <hr class="my-4">
                    <h6 class="text-muted mb-3">Font Spacing</h6>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Space Width</span>
                            <span class="slider-value" id="space-width-value">1800</span>
                        </div>
                        <input type="range" class="form-range" id="space-width" min="500" max="3000" step="50" value="1800" 
                               oninput="updateSliderValue('space-width-value', this.value); updatePreviewLive()">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Left Bearing</span>
                            <span class="slider-value" id="left-bearing-value">25</span>
                        </div>
                        <input type="range" class="form-range" id="left-bearing" min="0" max="100" step="5" value="25" 
                               oninput="updateSliderValue('left-bearing-value', this.value); updatePreviewLive()">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Right Bearing</span>
                            <span class="slider-value" id="right-bearing-value">25</span>
                        </div>
                        <input type="range" class="form-range" id="right-bearing" min="0" max="100" step="5" value="25" 
                               oninput="updateSliderValue('right-bearing-value', this.value); updatePreviewLive()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-xl-9 col-lg-8">
        <div class="row g-4">
    <!-- Upload Section -->
    <div class="col-lg-6 mb-4">
        <div class="card card-custom h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload me-2"></i>Upload Your Template
                </h5>
            </div>
            <div class="card-body">
                <div class="drop-zone" id="drop-zone">
                    <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                    <h5>Drop your filled template here</h5>
                    <p class="text-muted">Or click to browse files</p>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <button class="btn btn-outline-primary mt-2" onclick="event.stopPropagation(); console.log('Browse button clicked'); document.getElementById('file-input').click()">
                        Browse Files
                    </button>
                </div>
                
                <div id="upload-status" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <span id="upload-filename">File uploaded successfully!</span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label for="font-name" class="form-label">Font Name</label>
                    <input type="text" class="form-control" id="font-name" placeholder="MyCustomFont" value="MyFont">
                    <div class="form-text">This will be the name of your generated font</div>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-custom btn-lg" id="generate-preview" disabled>
                        <span class="btn-text">
                            <i class="bi bi-eye me-2"></i>Generate Preview
                        </span>
                        <div class="spinner-border spinner-border-sm loading-spinner me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
            <!-- Preview Section (Initially Hidden) -->
            <div class="col-12" id="preview-section" style="display: none;">
        <div class="card card-custom">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-eye me-2"></i>Font Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="preview-text-input" class="form-label">Sample Text</label>
                    <input type="text" class="form-control" id="preview-text-input" 
                           placeholder="Type your text here..." 
                           value="The quick brown fox jumps over the lazy dog">
                    <div class="mt-2">
                        <small class="text-muted">Try these examples:</small>
                        <div class="d-flex gap-2 flex-wrap mt-1">
                            <button class="btn btn-outline-secondary btn-sm" onclick="setPreviewText('Hello World')">Hello World</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setPreviewText('The quick brown fox jumps over the lazy dog')">Pangram</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setPreviewText('ABCabc123!@#')">Character Mix</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setPreviewText('My Custom Font')">My Custom Font</button>
                            <button class="btn btn-outline-info btn-sm" onclick="showAllCharacters()">All Characters</button>
                        </div>
                        <small class="text-muted d-block mt-2">Preview shows exactly how your final font will look</small>
                    </div>
                </div>
                
                <div class="preview-text" id="preview-display">
                    <!-- Preview will be rendered here -->
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-vector-pen display-4"></i>
                        <p class="mt-3">Your font preview will appear here</p>
                    </div>
                </div>
                
                <!-- Character Coverage (Hidden by default) -->
                <div id="character-coverage" style="display: none;" class="mt-3">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h6 class="card-title mb-2">
                                <i class="bi bi-grid-3x3-gap me-1"></i>Character Coverage
                                <span class="badge bg-primary ms-2" id="coverage-count">0</span>
                            </h6>
                            <div id="coverage-grid" class="d-flex flex-wrap gap-1">
                                <!-- Character coverage will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-info btn-lg" id="preview-final-font" disabled>
                        <span class="btn-text">
                            <i class="bi bi-eye-fill me-2"></i>Preview Final Font
                        </span>
                        <div class="spinner-border spinner-border-sm loading-spinner me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                    <button class="btn btn-success btn-lg" id="generate-font" disabled>
                        <span class="btn-text">
                            <i class="bi bi-download me-2"></i>Generate & Download TTF
                        </span>
                        <div class="spinner-border spinner-border-sm loading-spinner me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let uploadedFilePath = null;
let originalImagePath = null;
let characterMap = {};
let characterCustomizations = {}; // Store character-specific overrides
let currentEditingCharacter = null; // Currently being edited in modal
let fontSettings = {
    uppercase_scale: 4.0,
    lowercase_scale: 2.8,
    numbers_scale: 3.8,
    symbols_scale: 3.5,
    space_width: 1800,
    left_bearing: 25,
    right_bearing: 25
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateSliderValues();
    
});

function initializeEventListeners() {
    // File upload handling
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    console.log('Initializing event listeners');
    console.log('Drop zone element:', dropZone);
    console.log('File input element:', fileInput);
    
    if (!dropZone || !fileInput) {
        console.error('Could not find required elements!');
        return;
    }
    
    dropZone.addEventListener('click', () => {
        console.log('Drop zone clicked, triggering file input');
        console.log('File input before click:', fileInput);
        console.log('File input files before click:', fileInput.files);
        fileInput.click();
        
        // Test immediately after click
        setTimeout(() => {
            console.log('File input files after click (delayed):', fileInput.files);
        }, 1000);
    });
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('dragleave', handleDragLeave);
    dropZone.addEventListener('drop', handleDrop);
    
    // Add multiple ways to catch file selection
    fileInput.addEventListener('change', handleFileSelect);
    fileInput.addEventListener('input', handleFileSelect);
    fileInput.onchange = handleFileSelect;
    
    // Buttons
    const generatePreviewBtn = document.getElementById('generate-preview');
    const generateFontBtn = document.getElementById('generate-font');
    const previewFinalFontBtn = document.getElementById('preview-final-font');
    const toggleAdvancedBtn = document.getElementById('toggle-advanced');
    const resetDefaultsBtn = document.getElementById('reset-defaults');
    
    if (generatePreviewBtn) generatePreviewBtn.addEventListener('click', generatePreview);
    if (generateFontBtn) generateFontBtn.addEventListener('click', generateFont);
    if (previewFinalFontBtn) previewFinalFontBtn.addEventListener('click', previewFinalFont);
    if (toggleAdvancedBtn) toggleAdvancedBtn.addEventListener('click', toggleAdvanced);
    if (resetDefaultsBtn) resetDefaultsBtn.addEventListener('click', resetDefaults);
    
    // Sliders
    const sliders = ['uppercase-scale', 'lowercase-scale', 'numbers-scale', 'symbols-scale', 'space-width', 'left-bearing', 'right-bearing'];
    sliders.forEach(id => {
        const slider = document.getElementById(id);
        if (slider) {
            slider.addEventListener('input', function() {
                updateSliderValues();
                updatePreviewLive();
            });
        }
    });
    
    // Preview text input
    const previewTextInput = document.getElementById('preview-text-input');
    if (previewTextInput) previewTextInput.addEventListener('input', updatePreview);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFileSelect(e) {
    console.log('File input change event triggered');
    console.log('Files:', e.target.files);
    const files = e.target.files;
    if (files.length > 0) {
        console.log('File selected:', files[0]);
        handleFile(files[0]);
    } else {
        console.log('No files selected');
    }
}

async function handleFile(file) {
    console.log('File selected:', file.name, file.type, file.size);
    
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
    }
    
    // Show upload progress
    const uploadStatus = document.getElementById('upload-status');
    uploadStatus.style.display = 'block';
    uploadStatus.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-cloud-upload me-2"></i>
            Uploading ${file.name}...
            <div class="spinner-border spinner-border-sm ms-2" role="status"></div>
        </div>
    `;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        console.log('Uploading file...');
        const response = await fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        });
        
        console.log('Upload response:', response.status);
        const result = await response.json();
        console.log('Upload result:', result);
        
        if (result.success) {
            uploadedFilePath = result.file_path;
            uploadStatus.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="upload-filename">${result.filename} uploaded successfully!</span>
                </div>
            `;
            document.getElementById('generate-preview').disabled = false;
        } else {
            uploadStatus.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-2"></i>
                    Upload failed: ${result.detail || 'Unknown error'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                Upload error: ${error.message}
            </div>
        `;
    }
}

async function generatePreview() {
    if (!uploadedFilePath) {
        alert('Please upload an image first.');
        return;
    }
    
    const fontName = document.getElementById('font-name').value || 'MyFont';
    const button = document.getElementById('generate-preview');
    
    button.classList.add('loading');
    button.disabled = true;
    
    const formData = new FormData();
    formData.append('file_path', uploadedFilePath);
    formData.append('font_name', fontName);
    formData.append('uppercase_scale', fontSettings.uppercase_scale);
    formData.append('lowercase_scale', fontSettings.lowercase_scale);
    formData.append('numbers_scale', fontSettings.numbers_scale);
    formData.append('symbols_scale', fontSettings.symbols_scale);
    formData.append('space_width', fontSettings.space_width);
    formData.append('left_bearing', fontSettings.left_bearing);
    formData.append('right_bearing', fontSettings.right_bearing);
    
    try {
        const response = await fetch('/api/preview', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            originalImagePath = uploadedFilePath;
            characterMap = result.character_map;
            fontSettings = result.settings;
            
            document.getElementById('preview-section').style.display = 'block';
            document.getElementById('generate-font').disabled = false;
            document.getElementById('preview-final-font').disabled = false;
            
            // Show character coverage
            showCharacterCoverage();
            
            // Update preview display with SVG characters
            updatePreview();
            
            // Scroll to preview
            document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Preview generation failed: ' + result.detail);
        }
    } catch (error) {
        alert('Preview error: ' + error.message);
    } finally {
        button.classList.remove('loading');
        button.disabled = false;
    }
}

async function generateFont() {
    if (!originalImagePath) {
        alert('Please generate a preview first.');
        return;
    }
    
    const fontName = document.getElementById('font-name').value || 'MyFont';
    const button = document.getElementById('generate-font');
    
    button.classList.add('loading');
    button.disabled = true;
    
    const formData = new FormData();
    formData.append('original_image_path', originalImagePath);
    formData.append('font_name', fontName);
    
    // Add character customizations if any exist
    if (Object.keys(characterCustomizations).length > 0) {
        formData.append('character_customizations', JSON.stringify(characterCustomizations));
        console.log('Sending character customizations:', characterCustomizations);
    }
    
    try {
        const response = await fetch('/api/generate-font', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Create download link
            const a = document.createElement('a');
            a.href = result.font_url;
            a.download = result.font_file;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Show success message with test link
            const alert = document.createElement('div');
            alert.className = 'alert alert-success mt-3';
            alert.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                Font generated successfully! Download should start automatically.
                <div class="mt-2">
                    <a href="${result.test_url}" target="_blank" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-eye me-1"></i>Test Your Font
                    </a>
                </div>
            `;
            
            button.parentNode.insertBefore(alert, button.nextSibling);
            
            setTimeout(() => alert.remove(), 10000);
        } else {
            alert('Font generation failed: ' + result.detail);
        }
    } catch (error) {
        alert('Font generation error: ' + error.message);
    } finally {
        button.classList.remove('loading');
        button.disabled = false;
    }
}

function toggleAdvanced() {
    const advanced = document.getElementById('advanced-settings');
    const isVisible = advanced.style.display !== 'none';
    
    advanced.style.display = isVisible ? 'none' : 'block';
    
    const button = document.getElementById('toggle-advanced');
    button.innerHTML = isVisible ? 
        '<i class="bi bi-gear me-1"></i>Advanced' : 
        '<i class="bi bi-gear-fill me-1"></i>Basic';
}

function updateSliderValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    }
}

function updateSliderValues() {
    const sliders = {
        'uppercase-scale': 'uppercase-scale-value',
        'lowercase-scale': 'lowercase-scale-value',
        'numbers-scale': 'numbers-scale-value',
        'symbols-scale': 'symbols-scale-value',
        'space-width': 'space-width-value',
        'left-bearing': 'left-bearing-value',
        'right-bearing': 'right-bearing-value'
    };
    
    Object.entries(sliders).forEach(([sliderId, valueId]) => {
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(valueId);
        
        if (slider && valueDisplay) {
            let displayValue = slider.value;
            // Add 'x' suffix for scale values
            if (sliderId.includes('scale')) {
                displayValue += 'x';
            }
            valueDisplay.textContent = displayValue;
            
            // Update fontSettings
            const settingKey = sliderId.replace('-', '_');
            fontSettings[settingKey] = parseFloat(slider.value);
        }
    });
}

function updatePreview() {
    const previewText = document.getElementById('preview-text-input').value;
    const previewDisplay = document.getElementById('preview-display');
    
    if (Object.keys(characterMap).length > 0) {
        // Render text using SVG characters
        renderSVGText(previewText, previewDisplay);
    } else {
        previewDisplay.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-vector-pen display-4"></i>
                <p class="mt-3">Your font preview will appear here</p>
            </div>
        `;
    }
}

function renderSVGText(text, container) {
    container.innerHTML = '';
    
    const svgContainer = document.createElement('div');
    svgContainer.className = 'preview-content';
    
    // Render exactly as the final font will look - no extra spacing or controls
    const baseSize = 60; // Fixed size for consistent preview
    
    svgContainer.style.cssText = `
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: center;
        gap: 0px;
        line-height: 1.2;
        min-height: 100px;
        padding: 20px;
        font-size: 48px;
        letter-spacing: normal;
    `;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        if (char === ' ') {
            // Handle space character using actual font settings
            const spaceDiv = document.createElement('div');
            // Convert font units to pixels: space_width is in font units (like 1800), convert to reasonable pixels
            const spaceWidth = (fontSettings.space_width / 100) * (baseSize / 60); // Scale appropriately
            spaceDiv.style.cssText = `
                display: inline-block;
                width: ${spaceWidth}px;
                height: ${baseSize}px;
                vertical-align: baseline;
            `;
            svgContainer.appendChild(spaceDiv);
            continue;
        }
        
        if (char === '\n') {
            // Handle line breaks
            const breakDiv = document.createElement('div');
            breakDiv.style.width = '100%';
            breakDiv.style.height = '0px';
            svgContainer.appendChild(breakDiv);
            continue;
        }
        
        if (characterMap[char]) {
            const charData = characterMap[char];
            const scaleFactor = getCharacterScale(char);
            const charSize = baseSize * (scaleFactor / 4.0); // Normalize to base scale
            
            // Create SVG element for character
            const svgChar = createSVGCharacter(char, charData, charSize);
            svgContainer.appendChild(svgChar);
        } else {
            // Fallback for missing characters
            const fallback = document.createElement('span');
            fallback.textContent = char;
            fallback.style.cssText = `
                font-size: ${baseSize}px;
                font-family: monospace;
                color: #6c757d;
                display: inline-block;
            `;
            svgContainer.appendChild(fallback);
        }
    }
    
    container.appendChild(svgContainer);
}

function createSVGCharacter(char, charData, size) {
    const wrapper = document.createElement('div');
    
    // Use bearings settings (check for character customizations first)
    const customizations = characterCustomizations[char] || {};
    const leftBearingValue = customizations.left_bearing !== undefined ? customizations.left_bearing : fontSettings.left_bearing;
    const rightBearingValue = customizations.right_bearing !== undefined ? customizations.right_bearing : fontSettings.right_bearing;
    
    const leftBearing = (leftBearingValue / 10) * (size / 60); // Scale down for reasonable spacing
    const rightBearing = (rightBearingValue / 10) * (size / 60);
    
    wrapper.style.cssText = `
        display: inline-block;
        width: auto;
        height: ${size}px;
        vertical-align: baseline;
        margin-left: ${leftBearing}px;
        margin-right: ${rightBearing}px;
        padding: 0;
    `;
    
    if (charData.svg_content) {
        // Use the complete SVG content and modify it
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = charData.svg_content;
        const svg = tempDiv.querySelector('svg');
        
        if (svg) {
            // Update SVG size
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            
            // Make sure all paths are black
            const paths = svg.querySelectorAll('path');
            paths.forEach(path => {
                path.setAttribute('fill', '#000000');
            });
            
            wrapper.appendChild(svg);
        } else {
            // Fallback to old method if SVG parsing fails
            const svgEl = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgEl.setAttribute('viewBox', charData.svg_info.viewbox);
            svgEl.setAttribute('width', size);
            svgEl.setAttribute('height', size);
            
            charData.svg_info.paths.forEach(pathData => {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', '#000000');
                svgEl.appendChild(path);
            });
            
            wrapper.appendChild(svgEl);
        }
    } else {
        // Fallback if SVG data is not available
        wrapper.innerHTML = `<span style="font-size: ${size}px; color: #6c757d;">${char}</span>`;
    }
    
    return wrapper;
}

function getCharacterScale(char) {
    // Check if this character has individual customizations first
    if (characterCustomizations[char] && characterCustomizations[char].scale_factor !== undefined) {
        return characterCustomizations[char].scale_factor;
    }
    
    // Fall back to category defaults
    if (char.match(/[A-Z]/)) return fontSettings.uppercase_scale;
    if (char.match(/[a-z]/)) return fontSettings.lowercase_scale;
    if (char.match(/[0-9]/)) return fontSettings.numbers_scale;
    return fontSettings.symbols_scale;
}

function updatePreviewLive() {
    // Update preview in real-time as sliders change
    if (Object.keys(characterMap).length > 0) {
        updatePreview();
    }
}

function showCharacterCoverage() {
    console.log('showCharacterCoverage called with characterMap:', characterMap);
    const coverageSection = document.getElementById('character-coverage');
    const coverageGrid = document.getElementById('coverage-grid');
    const coverageCount = document.getElementById('coverage-count');
    
    coverageGrid.innerHTML = '';
    
    // Make coverage section visible
    coverageSection.style.display = 'block';
    
    // Sort characters for better display
    const sortedChars = Object.keys(characterMap).sort((a, b) => {
        // Sort by type: uppercase, lowercase, numbers, symbols
        if (a.match(/[A-Z]/) && !b.match(/[A-Z]/)) return -1;
        if (!a.match(/[A-Z]/) && b.match(/[A-Z]/)) return 1;
        if (a.match(/[a-z]/) && !b.match(/[a-z]/)) return -1;
        if (!a.match(/[a-z]/) && b.match(/[a-z]/)) return 1;
        if (a.match(/[0-9]/) && !b.match(/[0-9]/)) return -1;
        if (!a.match(/[0-9]/) && b.match(/[0-9]/)) return 1;
        return a.localeCompare(b);
    });
    
    sortedChars.forEach(char => {
        const charBox = document.createElement('span');
        
        // Check if character has customizations
        const hasCustomizations = characterCustomizations.hasOwnProperty(char);
        const badgeClass = hasCustomizations ? 'badge bg-warning text-dark' : 'badge bg-secondary';
        
        charBox.className = `${badgeClass} me-1 mb-1 position-relative`;
        charBox.style.cssText = 'font-size: 0.8rem; cursor: pointer; user-select: none;';
        charBox.textContent = char === ' ' ? '␣' : char;
        charBox.title = hasCustomizations 
            ? `"${char}" - Click to preview, Double-click to edit (CUSTOMIZED)`
            : `"${char}" - Click to preview, Double-click to edit`;
        
        // Add visual indicator for customized characters
        if (hasCustomizations) {
            const indicator = document.createElement('span');
            indicator.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning';
            indicator.style.cssText = 'font-size: 0.5rem; width: 8px; height: 8px; padding: 0;';
            indicator.innerHTML = '';
            charBox.appendChild(indicator);
        }
        
        // Single click - open sizing modal
        charBox.addEventListener('click', (e) => {
            openCharacterSizingModal(char);
        });
        
        coverageGrid.appendChild(charBox);
    });
    
    coverageCount.textContent = sortedChars.length;
    coverageSection.style.display = 'block';
}

function setPreviewText(text) {
    document.getElementById('preview-text-input').value = text;
    updatePreview();
}

function showAllCharacters() {
    // Get all available characters and organize by category
    const chars = Object.keys(characterMap);
    
    // Categorize characters
    const uppercase = chars.filter(char => /[A-Z]/.test(char)).sort();
    const lowercase = chars.filter(char => /[a-z]/.test(char)).sort();
    const numbers = chars.filter(char => /[0-9]/.test(char)).sort();
    const spanish = chars.filter(char => /[áéíóúüñÁÉÍÓÚÜÑ¿¡]/.test(char)).sort();
    const symbols = chars.filter(char => 
        !/[A-Za-z0-9áéíóúüñÁÉÍÓÚÜÑ¿¡\s]/.test(char)
    ).sort();
    
    // Build organized string: UPPERCASE + lowercase + numbers + spanish + symbols
    const organizedChars = [
        ...uppercase,
        ...lowercase, 
        ...numbers,
        ...spanish,
        ...symbols
    ].join('');
    
    setPreviewText(organizedChars);
}

function resetDefaults() {
    document.getElementById('uppercase-scale').value = 4.0;
    document.getElementById('lowercase-scale').value = 2.8;
    document.getElementById('numbers-scale').value = 3.8;
    document.getElementById('symbols-scale').value = 3.5;
    document.getElementById('space-width').value = 1800;
    document.getElementById('left-bearing').value = 25;
    document.getElementById('right-bearing').value = 25;
    
    updateSliderValues();
    updatePreviewLive();
}

// Character Sizing Modal Functions
function openCharacterSizingModal(char) {
    currentEditingCharacter = char;
    
    // Set modal title
    document.getElementById('modal-character').textContent = char === ' ' ? 'Space' : char;
    
    // Get default values for this character's category
    const defaults = getCharacterDefaults(char);
    
    // Apply current customizations or defaults
    const current = characterCustomizations[char] || {};
    
    // Set slider values
    const scale = current.scale_factor || defaults.scale_factor;
    const baseline = current.baseline_offset || defaults.baseline_offset;
    const leftBearing = current.left_bearing || fontSettings.left_bearing;
    const rightBearing = current.right_bearing || fontSettings.right_bearing;
    
    document.getElementById('char-scale').value = scale;
    document.getElementById('char-scale-value').textContent = scale.toFixed(1) + 'x';
    
    document.getElementById('char-baseline').value = baseline;
    document.getElementById('char-baseline-value').textContent = baseline;
    
    document.getElementById('char-left-bearing').value = leftBearing;
    document.getElementById('char-left-bearing-value').textContent = leftBearing;
    
    document.getElementById('char-right-bearing').value = rightBearing;
    document.getElementById('char-right-bearing-value').textContent = rightBearing;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('characterSizingModal'));
    modal.show();
}

function getCharacterDefaults(char) {
    // Determine character category and return defaults
    if (/[A-Z]/.test(char)) {
        return { scale_factor: fontSettings.uppercase_scale, baseline_offset: 150 };
    } else if (/[a-z]/.test(char)) {
        return { scale_factor: fontSettings.lowercase_scale, baseline_offset: 120 };
    } else if (/[0-9]/.test(char)) {
        return { scale_factor: fontSettings.numbers_scale, baseline_offset: 140 };
    } else if (/[áéíóúüñÁÉÍÓÚÜÑ¿¡]/.test(char)) {
        return { scale_factor: 3.5, baseline_offset: 140 };
    } else {
        // Symbols - check for existing individual scaling in config
        const symbolDefaults = { scale_factor: fontSettings.symbols_scale, baseline_offset: 130 };
        // Handle individual symbol scaling from config
        const individualScaling = {'.': 2.0, ',': 2.0, "'": 2.5, '`': 2.5, ':': 2.5, ';': 2.5, '-': 2.8, '_': 2.8};
        if (individualScaling[char]) {
            symbolDefaults.scale_factor = individualScaling[char];
        }
        return symbolDefaults;
    }
}

function updateCharacterSlider(property, value) {
    const valueElement = document.getElementById(`char-${property.replace('_', '-')}-value`);
    
    if (property === 'scale') {
        property = 'scale_factor';
        valueElement.textContent = parseFloat(value).toFixed(1) + 'x';
    } else if (property === 'baseline') {
        property = 'baseline_offset';
        valueElement.textContent = value;
    } else {
        valueElement.textContent = value;
    }
}

function resetCharacterToDefaults() {
    if (!currentEditingCharacter) return;
    
    // Remove any customizations for this character
    delete characterCustomizations[currentEditingCharacter];
    
    // Close modal and refresh display
    bootstrap.Modal.getInstance(document.getElementById('characterSizingModal')).hide();
    
    // Refresh character coverage to remove visual indicators
    showCharacterCoverage();
    
    // Update preview if this character is visible
    updatePreview();
}

function applyCharacterCustomization() {
    if (!currentEditingCharacter) return;
    
    const char = currentEditingCharacter;
    
    // Get values from sliders
    const scale = parseFloat(document.getElementById('char-scale').value);
    const baseline = parseInt(document.getElementById('char-baseline').value);
    const leftBearing = parseInt(document.getElementById('char-left-bearing').value);
    const rightBearing = parseInt(document.getElementById('char-right-bearing').value);
    
    // Get defaults to check what actually changed
    const defaults = getCharacterDefaults(char);
    const overrides = {};
    
    // Only store values that differ from defaults
    if (scale !== defaults.scale_factor) {
        overrides.scale_factor = scale;
    }
    if (baseline !== defaults.baseline_offset) {
        overrides.baseline_offset = baseline;
    }
    if (leftBearing !== fontSettings.left_bearing) {
        overrides.left_bearing = leftBearing;
    }
    if (rightBearing !== fontSettings.right_bearing) {
        overrides.right_bearing = rightBearing;
    }
    
    // Store customizations (or remove if no overrides)
    if (Object.keys(overrides).length > 0) {
        characterCustomizations[char] = overrides;
    } else {
        delete characterCustomizations[char];
    }
    
    // Close modal and refresh displays
    bootstrap.Modal.getInstance(document.getElementById('characterSizingModal')).hide();
    
    // Refresh character coverage to show/hide visual indicators
    showCharacterCoverage();
    
    // Update preview with new settings
    updatePreview();
    
    console.log(`Applied customizations for "${char}":`, characterCustomizations[char] || 'None');
}

// Preview final font function
async function previewFinalFont() {
    if (!originalImagePath) {
        alert('No image uploaded. Please upload a filled template first.');
        return;
    }
    
    try {
        // Show loading state
        const btn = document.getElementById('preview-final-font');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Generating Preview...';
        btn.disabled = true;
        
        // Generate temporary font with current character customizations
        const formData = new FormData();
        formData.append('original_image_path', originalImagePath);
        
        // Add character customizations if any
        if (Object.keys(characterCustomizations).length > 0) {
            formData.append('character_customizations', JSON.stringify(characterCustomizations));
        }
        
        const response = await fetch('/api/generate-temp-font', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Open font test page in new window
            const testWindow = window.open(result.test_url, '_blank', 'width=1200,height=800');
            if (!testWindow) {
                alert('Popup blocked. Please allow popups and try again.');
            }
        } else {
            alert('Failed to generate preview font: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        alert('Error generating preview: ' + error.message);
    } finally {
        // Reset button state
        const btn = document.getElementById('preview-final-font');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Load example template function
async function loadExampleTemplate() {
    try {
        // Show loading state
        const loadingIndicator = document.createElement('div');
        loadingIndicator.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="bi bi-hourglass-split me-2"></i>Loading example template...
            </div>
        `;
        document.body.insertBefore(loadingIndicator, document.body.firstChild);
        
        // Use the example template API endpoint
        const response = await fetch('/api/example-template');
        if (!response.ok) {
            throw new Error('Failed to load example template');
        }
        
        const blob = await response.blob();
        const file = new File([blob], 'example-template.png', { type: 'image/png' });
        
        // Remove loading indicator
        loadingIndicator.remove();
        
        // Process the file using existing handleFile function
        await handleFile(file);
        
        // Load pre-generated SVG data
        const svgResponse = await fetch('/api/example-svgs');
        if (svgResponse.ok) {
            const svgData = await svgResponse.json();
            if (svgData.success) {
                // Set the character map and enable preview immediately
                characterMap = svgData.character_map;
                originalImagePath = svgData.original_image_path;
                
                // Show the preview section and enable buttons
                document.getElementById('preview-section').style.display = 'block';
                document.getElementById('generate-preview').disabled = false;
                document.getElementById('generate-font').disabled = false;
                document.getElementById('preview-final-font').disabled = false;
                
                // Auto-generate preview
                updatePreview();
                showCharacterCoverage();
                
                console.log(`Loaded ${svgData.total_characters} pre-generated characters`);
            }
        }
        
        // Set font name to example
        document.getElementById('font-name').value = 'ExampleFont';
        
        // Show success message
        const successAlert = document.createElement('div');
        successAlert.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle me-2"></i>Example template loaded successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.insertBefore(successAlert, document.body.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (successAlert.parentNode) {
                successAlert.remove();
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error loading example template:', error);
        
        // Show error message
        const errorAlert = document.createElement('div');
        errorAlert.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>Failed to load example template. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.insertBefore(errorAlert, document.body.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (errorAlert.parentNode) {
                errorAlert.remove();
            }
        }, 5000);
    }
}

</script>
{% endblock %}