name: FontGen CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  DOCKER_IMAGE: fontgen

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fontforge potrace
        sudo apt-get install -y libcairo2-dev libpango1.0-dev libgdk-pixbuf2.0-dev
        sudo apt-get install -y libffi-dev libjpeg-dev libopenjp2-7-dev
        sudo apt-get install -y libtiff5-dev libwebp-dev libharfbuzz-dev libfribidi-dev
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r cli/requirements.txt
        
    - name: Run CLI tests
      run: |
        cd tests/cli
        python test_fontgen.py
        
    - name: Run core functionality tests
      run: |
        cd tests
        python test_core_functionality.py
        
    - name: Run comprehensive test suite
      run: |
        cd tests
        python run_all_tests.py

  docker-build:
    name: Build and Test Docker Container
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        
    - name: Test Docker container
      run: |
        # Start container
        docker run -d --name fontgen-test -p 8000:8000 ${{ env.DOCKER_IMAGE }}:latest
        
        # Wait for startup
        sleep 15
        
        # Check if container is running
        docker ps | grep fontgen-test
        
        # Test health check
        for i in {1..6}; do
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "‚úÖ Health check passed"
            break
          fi
          if [ $i -eq 6 ]; then
            echo "‚ùå Health check failed"
            docker logs fontgen-test
            exit 1
          fi
          echo "Health check attempt $i failed, retrying..."
          sleep 5
        done
        
        # Test API endpoints
        curl -f http://localhost:8000/api/config > /dev/null && echo "‚úÖ Config API working" || echo "‚ö†Ô∏è Config API not responding"
        curl -f http://localhost:8000/api/template > /dev/null && echo "‚úÖ Template API working" || echo "‚ö†Ô∏è Template API not responding"
        
        # Clean up
        docker rm -f fontgen-test
        
    - name: Upload Docker image to registry (on main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üöÄ Would upload to registry here (configure registry credentials)"
        # docker tag ${{ env.DOCKER_IMAGE }}:latest your-registry/${{ env.DOCKER_IMAGE }}:latest
        # docker push your-registry/${{ env.DOCKER_IMAGE }}:latest

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Bandit security scan
      uses: python-security/bandit@v1.0.0
      with:
        args: -r cli/ web_app/ -f json -o bandit-report.json
        
    - name: Upload Bandit results
      uses: actions/upload-artifact@v3
      with:
        name: bandit-report
        path: bandit-report.json

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Safety check
      run: |
        pip install safety
        safety check -r cli/requirements.txt --json --output safety-report.json
        
    - name: Upload Safety results
      uses: actions/upload-artifact@v3
      with:
        name: safety-report
        path: safety-report.json

  deploy-preview:
    name: Deploy Preview (PR)
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to preview environment
      run: |
        echo "üöÄ Deploying to preview environment..."
        echo "This would deploy to a staging/preview environment for PR testing"
        # Add your preview deployment logic here
        
    - name: Comment PR with preview URL
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üéâ Preview deployment ready! Check the preview environment for testing.'
          })

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, docker-build, security-scan, dependency-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to production
      run: |
        echo "üöÄ Deploying to production..."
        echo "This would deploy to your production environment (Render, etc.)"
        # Add your production deployment logic here
        
    - name: Notify deployment success
      run: |
        echo "‚úÖ Production deployment completed successfully!"
